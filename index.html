<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koddi Deal Lifecycle</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f8fafc; color: #0f172a; min-height: 100vh; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
  .header { text-align: center; margin-bottom: 32px; }
  .header h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
  .header p { color: #64748b; font-size: 15px; margin-top: 6px; max-width: 600px; margin-left: auto; margin-right: auto; }
  .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 28px; flex-wrap: wrap; }
  .tab-btn { padding: 10px 20px; border-radius: 10px; border: 2px solid #e2e8f0; background: #fff; color: #475569; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; font-family: inherit; }
  .tab-btn.active { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Timeline */
  .timeline { display: flex; align-items: flex-start; justify-content: center; gap: 0; margin-bottom: 32px; overflow-x: auto; padding: 0 8px; }
  .timeline-step { display: flex; align-items: center; flex-shrink: 0; }
  .step-btn { display: flex; flex-direction: column; align-items: center; gap: 6px; border-radius: 16px; padding: 12px 10px 10px; cursor: pointer; transition: all 0.25s; min-width: 90px; max-width: 110px; font-family: inherit; background: #fff; }
  .step-btn .icon { font-size: 26px; }
  .step-btn .label { font-size: 11px; font-weight: 700; text-align: center; line-height: 1.2; }
  .step-btn .num { font-size: 9px; font-weight: 600; border-radius: 6px; padding: 2px 6px; }
  .step-btn:not(.active) .num { color: #94a3b8; background: #f1f5f9; }
  .step-btn.active { transform: scale(1.05); }
  .step-btn.active .num { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.2); }
  .arrow-connector { display: flex; align-items: center; padding: 0 2px; }
  .arrow-line { width: 24px; height: 3px; border-radius: 2px; transition: background 0.3s; }
  .arrow-head { width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; transition: border-color 0.3s; }

  /* Detail Card */
  .detail-card { background: #fff; border-radius: 20px; overflow: hidden; }
  .card-header { padding: 20px 28px; color: #fff; }
  .card-header-row { display: flex; align-items: center; gap: 12px; }
  .card-header .icon { font-size: 36px; }
  .card-header .step-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; }
  .card-header h2 { font-size: 22px; font-weight: 800; margin: 0; }
  .card-header .summary { margin: 12px 0 0; font-size: 15px; opacity: 0.95; line-height: 1.5; }
  .card-body { padding: 24px 28px; }
  .section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #94a3b8; margin-bottom: 8px; }
  .service-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 20px; }
  .badge { border-radius: 20px; padding: 2px 10px; font-size: 12px; font-weight: 600; white-space: nowrap; display: inline-block; }
  .data-flow-box { background: #f8fafc; border-radius: 12px; padding: 14px 18px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
  .data-flow-box .value { font-size: 14px; font-weight: 600; color: #334155; font-family: 'Fira Code', monospace; }
  .detail-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
  .detail-num { width: 24px; height: 24px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; flex-shrink: 0; }
  .detail-item p { font-size: 14px; color: #475569; line-height: 1.55; }
  .db-note { background: #fffbeb; border-radius: 12px; padding: 14px 18px; border: 1px solid #fde68a; margin-top: 20px; }
  .db-note .label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #b45309; margin-bottom: 6px; }
  .db-note p { font-size: 13px; color: #78350f; line-height: 1.5; }
  .card-nav { display: flex; justify-content: space-between; padding: 0 28px 20px; }
  .nav-btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; font-family: inherit; }
  .nav-btn:disabled { cursor: default; }

  /* Architecture */
  .service-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 28px; }
  .svc-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
  .svc-card-header { padding: 16px 20px; display: flex; align-items: center; gap: 10px; }
  .svc-card-header .icon { font-size: 28px; }
  .svc-card-header .name { font-size: 15px; font-weight: 800; }
  .svc-card-header .role { font-size: 12px; font-weight: 600; opacity: 0.7; }
  .svc-card-body { padding: 16px 20px; }
  .svc-card-body .desc { font-size: 13px; color: #475569; line-height: 1.55; margin-bottom: 14px; }
  .responsibility { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .responsibility .dot { width: 6px; height: 6px; border-radius: 3px; flex-shrink: 0; }
  .responsibility span { font-size: 13px; color: #334155; }
  .flow-diagram { background: #fff; border-radius: 16px; padding: 28px; border: 1px solid #e2e8f0; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
  .flow-diagram h3 { margin: 0 0 20px; font-size: 17px; font-weight: 800; }
  .flow-row { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 10px; flex-wrap: wrap; margin-bottom: 4px; }
  .flow-row:nth-child(odd) { background: #f8fafc; }
  .flow-chip { border-radius: 8px; padding: 4px 10px; font-size: 12px; font-weight: 700; white-space: nowrap; }
  .flow-arrow { color: #94a3b8; font-size: 11px; font-weight: 700; background: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
  .flow-note { font-size: 12px; color: #64748b; font-style: italic; margin-left: 4px; }

  /* Statuses */
  .status-card { background: #fff; border-radius: 16px; padding: 28px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
  .status-card h3 { margin: 0 0 6px; font-size: 17px; font-weight: 800; }
  .status-card > p { color: #64748b; font-size: 14px; margin: 0 0 24px; line-height: 1.5; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
  @media (max-width: 700px) { .two-col { grid-template-columns: 1fr; } }
  .status-panel { border-radius: 14px; padding: 20px; }
  .status-panel h4 { margin: 0 0 4px; font-size: 15px; font-weight: 800; }
  .status-panel .subtitle { font-size: 12px; opacity: 0.7; margin: 0 0 14px; }
  .status-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 10px; }
  .status-item .icon { font-size: 16px; }
  .status-item .name { font-weight: 700; font-size: 13px; }
  .status-item .desc { font-size: 11px; color: #64748b; }
  .status-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
  .status-btn { border-radius: 12px; padding: 8px 18px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s; min-width: 90px; font-family: inherit; background: #fff; }
  .transitions-box { background: #fff; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; display: none; }
  .transitions-box.visible { display: block; }
  .transitions-box .title { font-weight: 700; font-size: 14px; color: #0f172a; margin-bottom: 10px; }
  .transition-chips { display: flex; gap: 8px; flex-wrap: wrap; }
  .transition-chip { border-radius: 10px; padding: 6px 14px; font-weight: 700; font-size: 13px; }
  .terminal-msg { font-size: 13px; color: #94a3b8; font-style: italic; }
  .serve-box { margin-top: 20px; background: #ecfdf5; border-radius: 12px; padding: 16px; border: 2px solid #10b981; display: flex; align-items: center; gap: 12px; }
  .serve-box .icon { font-size: 28px; }
  .serve-box .title { font-weight: 800; font-size: 14px; color: #047857; }
  .serve-box .desc { font-size: 13px; color: #065f46; margin-top: 4px; }
  .footer-legend { margin-top: 28px; padding: 16px 20px; background: #fff; border-radius: 14px; border: 1px solid #e2e8f0; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üîÑ Koddi Deal Lifecycle</h1>
    <p>How deals are created, approved, stored, and flow between services in the Koddi platform</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('lifecycle')">üìã Deal Lifecycle</button>
    <button class="tab-btn" onclick="switchTab('architecture')">üèóÔ∏è Service Architecture</button>
    <button class="tab-btn" onclick="switchTab('statuses')">üîÄ Status Transitions</button>
  </div>

  <!-- LIFECYCLE TAB -->
  <div id="tab-lifecycle" class="tab-content active">
    <div class="timeline" id="timeline"></div>
    <div class="detail-card" id="detail-card"></div>
  </div>

  <!-- ARCHITECTURE TAB -->
  <div id="tab-architecture" class="tab-content">
    <div class="service-grid" id="service-grid"></div>
    <div class="flow-diagram">
      <h3>üîó How Data Flows Between Services</h3>
      <div id="flow-rows"></div>
    </div>
  </div>

  <!-- STATUSES TAB -->
  <div id="tab-statuses" class="tab-content">
    <div class="status-card">
      <h3>üìä Two-Track Status System</h3>
      <p>Deals have two independent statuses that work together. A deal needs <strong>both</strong> an "Approved" review status and an "Active" lifecycle status to be served in auctions.</p>
      <div class="two-col">
        <div class="status-panel" style="background:#faf5ff;border:1px solid #e9d5ff">
          <h4 style="color:#7c3aed">üîç Review Status</h4>
          <p class="subtitle" style="color:#7c3aed">Publisher approval decision</p>
          <div class="status-item" style="border:1px solid #e9d5ff"><span class="icon">‚è≥</span><div><div class="name" style="color:#1e1b4b">Under Review</div><div class="desc">Default for new deals ‚Äî awaiting publisher decision</div></div></div>
          <div class="status-item" style="border:1px solid #e9d5ff"><span class="icon">‚úÖ</span><div><div class="name" style="color:#1e1b4b">Approved</div><div class="desc">Publisher has approved ‚Äî deal can become active</div></div></div>
          <div class="status-item" style="border:1px solid #e9d5ff"><span class="icon">‚ùå</span><div><div class="name" style="color:#1e1b4b">Denied</div><div class="desc">Publisher rejected ‚Äî deal will not be served</div></div></div>
        </div>
        <div class="status-panel" style="background:#f0fdf4;border:1px solid #bbf7d0">
          <h4 style="color:#16a34a">üìÖ Lifecycle Status</h4>
          <p class="subtitle" style="color:#16a34a">Based on dates and publisher actions</p>
          <div class="status-item" style="border:1px solid #bbf7d0"><span class="icon">‚è≥</span><div><div class="name" style="color:#052e16">Pending</div><div class="desc">Start date hasn't passed yet</div></div></div>
          <div class="status-item" style="border:1px solid #bbf7d0"><span class="icon">üü¢</span><div><div class="name" style="color:#052e16">Active</div><div class="desc">Approved + start date passed = live in auctions</div></div></div>
          <div class="status-item" style="border:1px solid #bbf7d0"><span class="icon">‚è∏Ô∏è</span><div><div class="name" style="color:#052e16">Paused</div><div class="desc">Publisher temporarily stopped the deal</div></div></div>
          <div class="status-item" style="border:1px solid #bbf7d0"><span class="icon">üèÅ</span><div><div class="name" style="color:#052e16">Ended</div><div class="desc">End date reached ‚Äî deal is finished</div></div></div>
        </div>
      </div>
      <h4 style="margin:0 0 12px;font-size:15px;font-weight:800">üéØ When Does a Deal Serve Ads?</h4>
      <div style="background:#f8fafc;border-radius:14px;padding:20px;border:1px solid #e2e8f0">
        <p style="margin:0 0 16px;font-size:13px;color:#475569;line-height:1.5">Click a status below to see its allowed transitions:</p>
        <div class="status-buttons" id="status-buttons"></div>
        <div class="transitions-box" id="transitions-box">
          <div class="title" id="transitions-title"></div>
          <div class="transition-chips" id="transition-chips"></div>
        </div>
        <div class="serve-box">
          <span class="icon">‚úÖ</span>
          <div>
            <div class="title">A deal serves ads when:</div>
            <div class="desc">Review Status = <strong>Approved</strong> &nbsp;AND&nbsp; Lifecycle Status = <strong>Active</strong> &nbsp;(start date passed, end date not reached)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-legend">
    <div class="section-label" style="margin-bottom:10px">Service Legend</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px" id="legend-badges"></div>
  </div>
</div>

<script>
const svcColors = {
  "koddi-console": { bg:"#ede9fe", text:"#6d28d9", border:"#c4b5fd" },
  "koddi-ssp-media": { bg:"#dbeafe", text:"#1d4ed8", border:"#93c5fd" },
  "koddi-control-center": { bg:"#d1fae5", text:"#047857", border:"#6ee7b7" },
  "koddi-auction-engine": { bg:"#fef3c7", text:"#b45309", border:"#fcd34d" },
  "External Form": { bg:"#f3f4f6", text:"#374151", border:"#d1d5db" },
  "Koddi Internal": { bg:"#fce7f3", text:"#be185d", border:"#f9a8d4" },
};

const stages = [
  { id:"intake", label:"Advertiser Intake", icon:"üìù", color:"#6366f1", services:["External Form"],
    summary:"An advertiser fills out a public intake form requesting to run ads through a publisher's commerce media network.",
    details:["Advertiser discovers the publisher's SSP program (usually via the DSP or the publisher directly)","They fill out an intake form with deal details: brand, products, DSP seat ID, budget, flight dates, and creative info","The form data lands in Koddi's system awaiting manual routing","Currently the \"Commerce Media Network\" field is open text, so automatic routing isn't possible yet (V2 will add a dropdown)"],
    dataFlow:"Intake Form ‚Üí Koddi Internal Queue", dbNote:null },
  { id:"routing", label:"Manual Routing", icon:"üßë‚Äçüíº", color:"#8b5cf6", services:["koddi-console","koddi-ssp-media"],
    summary:"A Koddi team member reviews the intake form and routes the deal to the correct publisher in the system.",
    details:["A human at Koddi reads the intake form and identifies which publisher (member group) the deal belongs to","They create the advertiser in Console if it doesn't already exist","They ensure the necessary entities (products, experiences) exist before deal creation","The deal is then created via the Console API, which passes through to SSP-Media"],
    dataFlow:"Koddi Internal ‚Üí koddi-console ‚Üí koddi-ssp-media", dbNote:"Deal record created in SSP-Media PostgreSQL database with review_status = 'Under Review' and status = 'Pending'" },
  { id:"creation", label:"Deal Creation", icon:"‚öôÔ∏è", color:"#3b82f6", services:["koddi-console","koddi-ssp-media"],
    summary:"The deal is created in the system. Console acts as a passthrough and SSP-Media stores the deal in its PostgreSQL database.",
    details:["Console receives the POST Create Deal request and forwards it to SSP-Media","SSP-Media creates the deal record in its PostgreSQL database","New deals default to disabled (review_status = 'Under Review') so they don't go live prematurely","The deal stores: external_deal_id, client_deal_id, bid_floor, auction_type, start/end dates, metadata, and entity associations","Deals can also be auto-created via the Entity Registration event topic (Console ‚Üí SSP-Media), which also defaults to disabled"],
    dataFlow:"Console API ‚Üí SSP-Media API ‚Üí PostgreSQL", dbNote:"SSP-Media PostgreSQL: deal table + advertiser_deal_association table. Columns include review_status_id, status_id, is_collection_deal, bid_floor, auction_type, etc." },
  { id:"review", label:"Publisher Review", icon:"üëÄ", color:"#0ea5e9", services:["koddi-console"],
    summary:"The publisher sees the proposed deal in their Koddi UI and can approve, reject, or leave it pending.",
    details:["The deal appears in the publisher's Deal Management page in the Console UI","Publishers can filter deals by status: All, Pending, Approved, Rejected, Paused","They see key info at a glance: Advertiser, DSP, Experience, bid floor, dates, impressions","The publisher makes a decision: Approve ‚úÖ, Reject ‚ùå, or leave as Pending","Two separate status tracks: Review Status (Under Review ‚Üí Approved/Denied) and Deal Status (Pending ‚Üí Active/Paused/Ended)"],
    dataFlow:"Publisher UI ‚Üí Console PATCH ‚Üí SSP-Media PATCH ‚Üí PostgreSQL", dbNote:"review_status_id updated (Under Review ‚Üí Approved or Denied). Deal status remains 'Pending' until start date passes." },
  { id:"activation", label:"Deal Activation", icon:"üöÄ", color:"#10b981", services:["koddi-ssp-media","koddi-control-center"],
    summary:"Once a deal is approved AND its start date has passed, SSP-Media pushes the deal data to Control Center for replication.",
    details:["A deal must have BOTH: review_status = 'Approved' AND start date in the past","SSP-Media publishes an Update Deal event to the message topic","Control Center receives the event and pushes deal configuration to Aerospike (the high-speed data store)","Control Center also signals Auction Engine to clear its cache so it picks up the new deal","A future daily job will automatically activate/deactivate deals based on their flight dates (Phase 2)"],
    dataFlow:"SSP-Media Event ‚Üí Control Center ‚Üí Aerospike + Auction Engine Cache Clear", dbNote:"Deal data replicated from PostgreSQL ‚Üí Aerospike. Auction Engine cache invalidated." },
  { id:"auction", label:"Live Auction", icon:"üè∑Ô∏è", color:"#f59e0b", services:["koddi-auction-engine"],
    summary:"The deal is now live. When a bid request comes in, Auction Engine uses the deal ID to negotiate with the DSP for ads.",
    details:["When a publisher's page loads, a bid request hits Koddi's Auction Engine","Auction Engine reads deal data from its cache (originally loaded from Aerospike via Control Center)","The deal ID is sent to the advertiser's DSP (e.g., The Trade Desk, Google DV360)","Advertisers on the DSP have targeted their campaign against this deal ID","The DSP returns a bid response with the ad creative and bid price","Auction Engine selects the winning bid and returns the ad to be displayed"],
    dataFlow:"Bid Request ‚Üí Auction Engine (reads cache/Aerospike) ‚Üí DSP ‚Üí Ad Served", dbNote:"Auction Engine reads deal config from in-memory cache backed by Aerospike. No direct DB writes during auction." },
  { id:"management", label:"Ongoing Management", icon:"üîÑ", color:"#ef4444", services:["koddi-console","koddi-ssp-media","koddi-control-center","koddi-auction-engine"],
    summary:"Publishers can pause, reject, or update active deals. Changes flow back through the full pipeline to update live auction behavior.",
    details:["Publishers can update deal details: name, bid floor, dates, metadata, or change status","Status transitions are controlled: Approved ‚Üí Paused/Rejected/Expired, Paused ‚Üí Approved/Rejected/Expired, etc.","Updates flow: Console PATCH ‚Üí SSP-Media PATCH ‚Üí PostgreSQL update ‚Üí Event to Control Center ‚Üí Aerospike update ‚Üí Auction Engine cache clear","Only deals with 'Active' status AND 'Approved' review status get pushed to Control Center","If a deal is paused or rejected, it's effectively removed from auction (Control Center/Aerospike updated accordingly)","Expired deals cannot be reactivated by publishers (only by Koddi admins)"],
    dataFlow:"Console UI ‚Üí SSP-Media ‚Üí Control Center ‚Üí Aerospike ‚Üí Auction Engine", dbNote:"All updates go through SSP-Media PostgreSQL first, then replicated downstream only if deal qualifies (active + approved)." },
];

const statusTransitions = [
  { from:"Pending", to:["Approved","Rejected","Expired"], color:"#94a3b8" },
  { from:"Approved", to:["Paused","Rejected","Expired"], color:"#10b981" },
  { from:"Paused", to:["Approved","Rejected","Expired"], color:"#f59e0b" },
  { from:"Rejected", to:["Approved","Expired"], color:"#ef4444" },
  { from:"Expired", to:[], color:"#6b7280" },
];

const flows = [
  { from:"Publisher / Koddi Admin", arrow:"API Request", to:"koddi-console", note:"REST API calls for CRUD operations" },
  { from:"koddi-console", arrow:"Passthrough", to:"koddi-ssp-media", note:"Console forwards all deal operations to SSP-Media" },
  { from:"koddi-ssp-media", arrow:"PostgreSQL", to:"Deal Database", note:"Source of truth ‚Äî all deal data written and read here" },
  { from:"koddi-ssp-media", arrow:"Event Topic", to:"koddi-control-center", note:"Only publishes events for Active + Approved deals" },
  { from:"koddi-control-center", arrow:"Replication", to:"Aerospike", note:"High-speed data store for auction-time reads" },
  { from:"koddi-control-center", arrow:"Cache Clear", to:"koddi-auction-engine", note:"Signals engine to reload deal data" },
  { from:"koddi-auction-engine", arrow:"Bid Request", to:"DSP (Trade Desk, etc.)", note:"Sends deal ID to DSP, receives bid responses" },
];

const svcs = [
  { name:"koddi-console", icon:"üñ•Ô∏è", role:"API Gateway & Publisher UI",
    desc:"The front door. Console provides the publisher-facing UI and acts as a secure passthrough for all deal operations. It handles authentication, authorization (via member group IDs), and routes requests to SSP-Media.",
    owns:["Publisher Deal Management UI","Auth guards & user permissions","Passthrough API endpoints","Entity Registration event producer"] },
  { name:"koddi-ssp-media", icon:"üóÑÔ∏è", role:"Deal Data Owner & Business Logic",
    desc:"The source of truth. SSP-Media owns the deal database (PostgreSQL), performs all validations, and is responsible for the core business logic of deal creation, updates, and status management.",
    owns:["PostgreSQL deal tables","Deal CRUD operations","Status validation logic","Deal event publishing to Control Center"] },
  { name:"koddi-control-center", icon:"üì°", role:"Data Replication & Distribution",
    desc:"The bridge. Control Center receives deal update events from SSP-Media and replicates the data to Aerospike (high-speed store) and signals Auction Engine to refresh its cache.",
    owns:["Aerospike data replication","Auction Engine cache invalidation","Event consumption from SSP-Media","Deal data transformation for auction use"] },
  { name:"koddi-auction-engine", icon:"‚ö°", role:"Real-Time Auction Execution",
    desc:"The performer. Auction Engine uses cached deal data to run real-time bid auctions. It sends deal IDs to DSPs and selects winning bids ‚Äî all in milliseconds.",
    owns:["In-memory deal cache","Real-time bid request/response","DSP communication","Winner selection logic"] },
];

let activeStep = 0;
let selStatus = null;

function badge(name) {
  const c = svcColors[name] || svcColors["External Form"];
  return `<span class="badge" style="background:${c.bg};color:${c.text};border:1px solid ${c.border}">${name}</span>`;
}

function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(el => { if (el.textContent.toLowerCase().includes(id.substring(0,5))) el.classList.add('active'); });
}

function setStep(i) {
  activeStep = i;
  renderTimeline();
  renderDetail();
}

function renderTimeline() {
  const el = document.getElementById('timeline');
  let h = '';
  stages.forEach((s, i) => {
    const isActive = i === activeStep;
    const bg = isActive ? s.color : '#fff';
    const labelColor = isActive ? '#fff' : s.color;
    const shadow = isActive ? `0 4px 20px ${s.color}44` : '0 1px 4px rgba(0,0,0,0.06)';
    const scale = isActive ? 'scale(1.05)' : 'scale(1)';
    h += `<div class="timeline-step">
      <button class="step-btn ${isActive?'active':''}" onclick="setStep(${i})" style="background:${bg};border:3px solid ${s.color};box-shadow:${shadow};transform:${scale}">
        <span class="icon">${s.icon}</span>
        <span class="label" style="color:${labelColor}">${s.label}</span>
        <span class="num">Step ${i+1}</span>
      </button>`;
    if (i < stages.length - 1) {
      const lineColor = i < activeStep ? stages[i+1].color : '#e2e8f0';
      h += `<div class="arrow-connector"><div class="arrow-line" style="background:${lineColor}"></div><div class="arrow-head" style="border-left:8px solid ${lineColor}"></div></div>`;
    }
    h += '</div>';
  });
  el.innerHTML = h;
}

function renderDetail() {
  const s = stages[activeStep];
  const el = document.getElementById('detail-card');
  let detailsHtml = '';
  s.details.forEach((d, i) => {
    detailsHtml += `<div class="detail-item"><div class="detail-num" style="background:${s.color}15;color:${s.color};border:1px solid ${s.color}33">${i+1}</div><p>${d}</p></div>`;
  });
  let dbHtml = '';
  if (s.dbNote) {
    dbHtml = `<div class="db-note"><div class="label">üíæ Data Storage</div><p>${s.dbNote}</p></div>`;
  }
  el.style.border = `2px solid ${s.color}22`;
  el.style.boxShadow = `0 8px 32px ${s.color}11`;
  el.innerHTML = `
    <div class="card-header" style="background:linear-gradient(135deg,${s.color},${s.color}cc)">
      <div class="card-header-row"><span class="icon">${s.icon}</span><div><div class="step-label">Step ${activeStep+1} of ${stages.length}</div><h2>${s.label}</h2></div></div>
      <p class="summary">${s.summary}</p>
    </div>
    <div class="card-body">
      <div class="section-label">Services Involved</div>
      <div class="service-badges">${s.services.map(badge).join('')}</div>
      <div class="data-flow-box"><div class="section-label" style="margin-bottom:6px">Data Flow</div><div class="value">${s.dataFlow}</div></div>
      <div class="section-label" style="margin-bottom:10px">What Happens</div>
      ${detailsHtml}
      ${dbHtml}
    </div>
    <div class="card-nav">
      <button class="nav-btn" onclick="setStep(${activeStep-1})" ${activeStep===0?'disabled':''} style="border:2px solid #e2e8f0;background:${activeStep===0?'#f8fafc':'#fff'};color:${activeStep===0?'#cbd5e1':'#475569'}">‚Üê Previous</button>
      <button class="nav-btn" onclick="setStep(${activeStep+1})" ${activeStep===stages.length-1?'disabled':''} style="border:2px solid ${activeStep===stages.length-1?'#e2e8f0':s.color};background:${activeStep===stages.length-1?'#f8fafc':s.color};color:${activeStep===stages.length-1?'#cbd5e1':'#fff'}">Next ‚Üí</button>
    </div>`;
}

function renderArchitecture() {
  const grid = document.getElementById('service-grid');
  grid.innerHTML = svcs.map(svc => {
    const c = svcColors[svc.name];
    return `<div class="svc-card" style="border:2px solid ${c.border}">
      <div class="svc-card-header" style="background:${c.bg};border-bottom:1px solid ${c.border}">
        <span class="icon">${svc.icon}</span><div><div class="name" style="color:${c.text}">${svc.name}</div><div class="role" style="color:${c.text}">${svc.role}</div></div>
      </div>
      <div class="svc-card-body">
        <p class="desc">${svc.desc}</p>
        <div class="section-label" style="margin-bottom:8px">Responsibilities</div>
        ${svc.owns.map(o => `<div class="responsibility"><div class="dot" style="background:${c.text}"></div><span>${o}</span></div>`).join('')}
      </div>
    </div>`;
  }).join('');

  const fr = document.getElementById('flow-rows');
  fr.innerHTML = flows.map(f => {
    const fc = svcColors[f.from] || svcColors["External Form"];
    const tc = svcColors[f.to] || svcColors["External Form"];
    return `<div class="flow-row">
      <span class="flow-chip" style="background:${fc.bg};color:${fc.text};border:1px solid ${fc.border}">${f.from}</span>
      <span class="flow-arrow">${f.arrow} ‚Üí</span>
      <span class="flow-chip" style="background:${tc.bg};color:${tc.text};border:1px solid ${tc.border}">${f.to}</span>
      <span class="flow-note">${f.note}</span>
    </div>`;
  }).join('');
}

function renderStatusButtons() {
  const el = document.getElementById('status-buttons');
  el.innerHTML = statusTransitions.map(st =>
    `<button class="status-btn" onclick="toggleStatus('${st.from}')" style="border:2px solid ${st.color};color:${st.color}" data-status="${st.from}">${st.from}</button>`
  ).join('');
}

function toggleStatus(name) {
  selStatus = selStatus === name ? null : name;
  document.querySelectorAll('.status-btn').forEach(btn => {
    const st = statusTransitions.find(s => s.from === btn.dataset.status);
    const isActive = btn.dataset.status === selStatus;
    btn.style.background = isActive ? st.color : '#fff';
    btn.style.color = isActive ? '#fff' : st.color;
  });
  const box = document.getElementById('transitions-box');
  if (!selStatus) { box.classList.remove('visible'); return; }
  box.classList.add('visible');
  const st = statusTransitions.find(s => s.from === selStatus);
  document.getElementById('transitions-title').textContent = `From "${selStatus}" you can go to:`;
  const chips = document.getElementById('transition-chips');
  if (st.to.length > 0) {
    chips.innerHTML = st.to.map(t => {
      const tc = statusTransitions.find(s => s.from === t)?.color || '#6b7280';
      return `<span class="transition-chip" style="background:${tc}15;color:${tc};border:2px solid ${tc}">‚Üí ${t}</span>`;
    }).join('');
  } else {
    chips.innerHTML = '<p class="terminal-msg">‚õî Expired is a terminal state. Only a Koddi admin can change this.</p>';
  }
}

function renderLegend() {
  const el = document.getElementById('legend-badges');
  el.innerHTML = Object.keys(svcColors).filter(k => k.startsWith('koddi-')).map(badge).join('');
}

// Init
renderTimeline();
renderDetail();
renderArchitecture();
renderStatusButtons();
renderLegend();
</script>

</body>
</html>
